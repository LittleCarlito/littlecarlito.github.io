<!DOCTYPE html>
<html>
<head>
    <link href="https://fonts.googleapis.com/css2?family=Caveat&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/opentype.js/dist/opentype.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-height: 100vh;
            background: transparent;
            overflow: hidden;
        }

        .writing-container {
            width: 100%;
            position: relative;
            opacity: 0;
            padding-left: 30px;
        }

        .writing-container.show {
            opacity: 1;
        }

        .text-path {
            fill: none;
            stroke: black;
            stroke-width: 2;
        }

        .text-path.hidden {
            stroke-dashoffset: 1000;
        }

        @keyframes write-text {
            to {
                stroke-dashoffset: 0;
            }
        }

        .text-path.animate-write {
            animation: write-text 1s forwards;
        }

        .title-text {
            font-size: 96px;
        }

        .project-text {
            font-size: 48px;
        }

        .hidden {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
        }

        .animate-write {
            animation: write-text forwards;
        }

        @font-face {
            font-family: 'TokyoRockstar';
            src: url('/fonts/TokyoRockstar.ttf') format('truetype');
        }

        #title_svg {
            width: 800px;
            height: auto;
            display: block;
            max-height: 100vh;
            margin-left: 0;
        }

        .letter-path {
            fill: none;
            stroke: #000;
            stroke-width: 2px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .letter-path.animate {
            /* Controls letter animation speed: 0.6s = faster, 1.2s = slower */
            animation: drawLetter .025s forwards;
        }

        @keyframes drawLetter {
            0% {
                fill: transparent;
                stroke-dashoffset: var(--path-length);
            }
            70% {
                fill: transparent;
                stroke-dashoffset: 0;
            }
            100% {
                fill: #000;
                stroke-dashoffset: 0;
            }
        }
    </style>
</head>
<body>
    <div class="writing-container">
        <svg id="title_svg" width="800" height="800" viewBox="0 0 800 800">
            <!-- SVG content will be added here via JavaScript -->
        </svg>
    </div>

    <script type="module">
        import { FLAGS } from '../../common';

        // Configuration constants
        const ORIGINAL_SVG_WIDTH = 800;
        const LINK_LEFT_MARGIN = 60;
        const BASE_Y = 180;
        const Y_SPACING = 80;
        
        // Single source of truth for all projects
        const PROJECTS = [
            {
                text: 'ThreeJS tutorials',
                url: 'https://www.youtube.com/@Blooooork',
                width: 285,
                height: 35,
                yOffset: -15
            },
            {
                text: 'Chuck Chucker',
                url: 'https://github.com/LittleCarlito/chucker',
                width: 250,
                height: 32,
                yOffset: -5
            },
            {
                text: 'Recipeat',
                url: 'https://github.com/LittleCarlito/Recipeat',
                width: 144,
                height: 35,
                yOffset: 0
            },
            {
                text: 'SaveScummer',
                url: 'https://github.com/LittleCarlito/SaveScummer',
                width: 234,
                height: 35,
                yOffset: 5
            },
            {
                text: 'JPaint',
                url: 'https://github.com/LittleCarlito/JPaint',
                width: 114,
                height: 35,
                yOffset: 15
            },
            {
                text: 'Springville Family Dentistry webiste',
                url: 'https://github.com/LittleCarlito/springvilleSite',
                width: 568,
                height: 45,
                yOffset: 20
            },
            {
                text: 'This website',
                url: 'https://github.com/LittleCarlito/threejs_site',
                width: 200,
                height: 35,
                yOffset: 34
            }
        ];

        // Generate PROJECT_LINKS dynamically
        const PROJECT_LINKS = PROJECTS.map((project, index) => ({
            y: BASE_Y + (index * Y_SPACING),
            height: project.height,
            width: project.width,
            yOffset: project.yOffset,
            url: project.url
        }));

        // Generate projectElements dynamically
        const projectElements = PROJECTS.map(project => ({
            text: project.text,
            duration: 600,
            class: 'project-text'
        }));

        let font = null;
        opentype.load('/fonts/TokyoRockstar.ttf', function(err, loadedFont) {
            if (err && FLAGS.HTML_LOGS) {
                console.error('Font could not be loaded:', err);
                return;
            }
            font = loadedFont;
            if(FLAGS.HTML_LOGS) {
                console.log('Font loaded successfully');
            }

            // After font loads
            const debugContainer = document.createElement('div');
            debugContainer.style.position = 'absolute';
            debugContainer.style.top = '0';
            debugContainer.style.left = '0';
            debugContainer.style.width = '100%';
            debugContainer.style.height = '100%';
            debugContainer.style.zIndex = '100';
            document.body.appendChild(debugContainer);

            if(FLAGS.HTML_LOGS) {
                console.log('Debug container created');
            }

            // Y positions, heights, widths, and offsets tuned for each item
            const boxConfigs = [
                { y: 180, height: 35, width: 285, yOffset: -40, url: 'https://www.youtube.com/@Blooooork' },  // ThreeJS tutorials
                { y: 260, height: 35, width: 200, yOffset: -42, url: '#' },  // Recipeat
                { y: 340, height: 35, width: 144, yOffset: -42, url: 'https://github.com/LittleCarlito/Recipeat' },  // SaveScummer
                { y: 420, height: 35, width: 234, yOffset: -45, url: 'https://github.com/LittleCarlito/SaveScummer' },  // JPaint
                { y: 500, height: 45, width: 114, yOffset: -48, url: 'https://github.com/LittleCarlito/JPaint' },  // Springville
                { y: 580, height: 35, width: 565, yOffset: -50, url: 'https://github.com/LittleCarlito/springvilleSite' },  // This website
                { y: 660, height: 35, width: 200, yOffset: -50, url: 'https://github.com/LittleCarlito/threejs_site' }   // This website
            ];

            boxConfigs.forEach((config, index) => {
                const link = document.createElement('a');
                link.href = config.url;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.style.position = 'absolute';
                link.style.left = '60px';
                link.style.top = `${config.y + config.yOffset}px`;
                link.style.width = `${config.width}px`;
                link.style.height = `${config.height}px`;
                if(FLAGS.VISUAL_DEBUG) {
                    link.style.backgroundColor = `rgba(255, 0, 0, 0.3)`;
                }
                link.style.cursor = 'pointer';
                debugContainer.appendChild(link);
                
                if(FLAGS.HTML_LOGS) {
                    console.log(`Created link ${index + 1} at y=${config.y}`);
                }
            });

            // Verify container has children
            if(FLAGS.HTML_LOGS) {
                console.log('Number of links created:', debugContainer.children.length);
            }

            // After creating the debug container and links, call updateBoxPositions
            updateBoxPositions();

            // Calculate viewBox height based on number of projects
            const TITLE_HEIGHT = 100;  // Space for "Projects" title
            const TOTAL_PROJECTS = PROJECTS.length;
            const TOTAL_HEIGHT = TITLE_HEIGHT + (TOTAL_PROJECTS * Y_SPACING) + 100;  // Extra padding at bottom

            // Update SVG viewBox when font loads
            const svg = document.querySelector('#title_svg');
            svg.setAttribute('viewBox', `0 0 800 ${TOTAL_HEIGHT}`);
            svg.setAttribute('height', TOTAL_HEIGHT);
        });

        // Constants for positioning
        const TITLE_X = 30;  // Keep this value for left margin
        const TITLE_Y = 100;
        const TITLE_FONT_SIZE = 96;
        
        const PROJECT_START_X = 60;  // Adjust this to be closer to TITLE_X
        const PROJECT_START_Y = 180;
        const PROJECT_FONT_SIZE = 48;
        const PROJECT_SPACING = 80;

        const container = document.querySelector('.writing-container');
        const svg = document.querySelector('#title_svg');
        svg.setAttribute('viewBox', '0 0 800 600');
        svg.style.width = '100%';
        svg.style.maxWidth = '800px';
        svg.style.height = 'auto';
        svg.style.position = 'absolute';
        svg.style.left = '0';

        container.style.position = 'relative';
        container.style.width = '100%';
        container.style.maxWidth = '800px';
        
        // Separate title and project elements
        const titleText = { text: 'Projects', duration: 800, class: 'title-text' };
        
        // Remove localStorage state for testing
        localStorage.removeItem('projects_has_played');

        function createCharacterPath(char, x, y, className, fontSize) {
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("class", `text-path hidden ${className}`);
            const pathData = getPathDataForChar(char, x, y, fontSize);
            path.setAttribute("d", pathData);
            
            // Get the path length for animation
            const length = path.getTotalLength();
            path.style.strokeDasharray = length;
            path.style.strokeDashoffset = length;  // Start hidden
            
            return path;
        }

        function getPathDataForChar(char, x, y, fontSize) {
            if(FLAGS.HTML_LOGS) {
                console.log(`Generating path for char: ${char}, x: ${x}, y: ${y}, fontSize: ${fontSize}`);
            }
            const path = font.getPath(char, x, y, fontSize);
            return path.toPathData();
        }

        function animateCharacter(char, x, y, fontSize) {
            return new Promise((resolve) => {
                if(FLAGS.HTML_LOGS) {
                    console.log('Generating path for char:', char, 'x:', x, 'y:', y, 'fontSize:', fontSize);
                }
                
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                const pathData = getPathDataForChar(char, x, y, fontSize);
                path.setAttribute('d', pathData);
                path.setAttribute('class', 'letter-path');
                
                const svg = document.querySelector('svg');
                svg.appendChild(path);
                if(FLAGS.HTML_LOGS) {
                    console.log('Starting animation for character:', char);
                }
                
                const pathLength = path.getTotalLength();
                path.style.strokeDasharray = pathLength;
                path.style.setProperty('--path-length', pathLength);
                path.style.strokeDashoffset = pathLength;
                
                requestAnimationFrame(() => {
                    path.classList.add('animate');
                });

                path.addEventListener('animationend', () => {
                    if(FLAGS.HTML_LOGS) {   
                        console.log('Finished animating:', char);
                    }
                    setTimeout(resolve, 10);
                });
            });
        }

        async function animateAllText() {
            const allCharacters = [];
            let currentX = TITLE_X;
            let currentY = TITLE_Y;

            // Collect title characters
            titleText.text.split('').forEach(char => {
                allCharacters.push({
                    char,
                    x: currentX,
                    y: currentY,
                    fontSize: TITLE_FONT_SIZE,
                    class: titleText.class
                });
                currentX += font.getAdvanceWidth(char, TITLE_FONT_SIZE);
            });

            // Collect project characters
            currentY = PROJECT_START_Y;
            projectElements.forEach(item => {
                currentX = PROJECT_START_X;
                item.text.split('').forEach(char => {
                    allCharacters.push({
                        char,
                        x: currentX,
                        y: currentY,
                        fontSize: PROJECT_FONT_SIZE,
                        class: item.class
                    });
                    currentX += font.getAdvanceWidth(char, PROJECT_FONT_SIZE);
                });
                currentY += PROJECT_SPACING;
            });

            // Animate one at a time, waiting for each to finish
            const charDuration = 10; // Duration per character
            
            for (let charInfo of allCharacters) {
                if(FLAGS.HTML_LOGS) {
                    console.log('Creating character:', charInfo.char);
                }
                const charPath = createCharacterPath(
                    charInfo.char, 
                    charInfo.x, 
                    charInfo.y, 
                    charInfo.class, 
                    charInfo.fontSize
                );
                svg.appendChild(charPath);
                await animateCharacter(charInfo.char, charInfo.x, charInfo.y, charInfo.fontSize);
            }
        }

        function showAllText() {
            // Show title
            const titleChars = titleText.text.split('');
            let currentX = TITLE_X;
            let titleY = TITLE_Y;  // Renamed to avoid duplicate declaration
            
            titleChars.forEach(char => {
                const charPath = createCharacterPath(char, currentX, titleY, titleText.class, TITLE_FONT_SIZE);
                charPath.style.strokeDashoffset = 0;
                svg.appendChild(charPath);
                currentX += font.getAdvanceWidth(char, TITLE_FONT_SIZE);
            });

            // Show projects
            let projectY = PROJECT_START_Y;  // Renamed to be unique
            projectElements.forEach((item) => {
                const chars = item.text.split('');
                let currentX = PROJECT_START_X;
                
                chars.forEach(char => {
                    const charPath = createCharacterPath(char, currentX, projectY, item.class, PROJECT_FONT_SIZE);
                    charPath.style.strokeDashoffset = 0;
                    svg.appendChild(charPath);
                    currentX += font.getAdvanceWidth(char, PROJECT_FONT_SIZE);
                });

                projectY += PROJECT_SPACING;
            });
        }

        async function animateTitle() {
            const state = localStorage.getItem('animationPlayed');
            if(FLAGS.HTML_LOGS) {
                console.log('Animation triggered - localStorage state:', state);
            }
            
            if (!state) {
                if(FLAGS.HTML_LOGS) {
                    console.log('First time - playing animation');
                }
                localStorage.setItem('animationPlayed', 'true');
                
                // Create array of characters to animate
                const chars = ['P', 'r', 'o', 'j', 'e', 'c', 't', 's'];
                const fontSize = 96;
                let xOffset = 30;
                const yPos = 100;
                
                // Second row
                const chars2 = ['P', 'r', 'o', 'j'];
                const fontSize2 = 48;
                let xOffset2 = 100;
                const yPos2 = 180;

                // Animate first row
                for (let char of chars) {
                    if(FLAGS.HTML_LOGS) {
                        console.log('Creating character:', char);
                    }
                    await animateCharacter(char, xOffset, yPos, fontSize);
                    xOffset += fontSize * 0.768; // Adjust spacing between characters
                }

                // Animate second row
                for (let char of chars2) {
                    if(FLAGS.HTML_LOGS) {
                        console.log('Creating character:', char);
                    }
                    await animateCharacter(char, xOffset2, yPos2, fontSize2);
                    xOffset2 += fontSize2 * 0.768; // Adjust spacing between characters
                }
            }
        }

        window.trigger_frame_animation = function() {
            if(FLAGS.HTML_LOGS) {
                console.log("Animation triggered - localStorage state:", localStorage.getItem('projects_has_played'));
            }
            if(!localStorage.getItem('projects_has_played')) {
                if(FLAGS.HTML_LOGS) {
                    console.log("First time - playing animation");
                }
                container.classList.add('show');
                animateAllText();
                localStorage.setItem('projects_has_played', true);
            } else {
                container.classList.add('show');
                showAllText();
            }
        };

        function updateBoxPositions() {
            const svg = document.querySelector('#title_svg');
            const svgRect = svg.getBoundingClientRect();
            const scale = svgRect.width / ORIGINAL_SVG_WIDTH;

            const debugContainer = document.querySelector('div[style*="position: absolute"]');
            const links = debugContainer.getElementsByTagName('a');

            PROJECT_LINKS.forEach((config, index) => {
                if (links[index]) {
                    const link = links[index];
                    link.style.left = `${LINK_LEFT_MARGIN * scale}px`;
                    link.style.top = `${(config.y * scale * 0.9 + config.yOffset * scale)}px`;
                    link.style.width = `${config.width * scale}px`;
                    link.style.height = `${config.height * scale}px`;
                }
            });
        }

        // Add resize event listener
        window.addEventListener('resize', updateBoxPositions);
    </script>
</body>
</html>
