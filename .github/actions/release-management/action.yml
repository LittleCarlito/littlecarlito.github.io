name: 'Release Management'
description: 'Handles release operations including version bumping and publishing'

inputs:
  github-token:
    description: 'GitHub token for authentication'
    required: true
  repository:
    description: 'Repository name (owner/repo)'
    required: true
  package-name:
    description: 'Package name to release'
    required: false
    default: 'all'
  version-type:
    description: 'Version bump type (major, minor, patch)'
    required: false
    default: 'patch'
  draft:
    description: 'Create release as draft'
    required: false
    default: 'false'
  prerelease:
    description: 'Mark as prerelease'
    required: false
    default: 'false'
  generate-notes:
    description: 'Auto-generate release notes'
    required: false
    default: 'true'

outputs:
  version:
    description: 'New version number'
    value: ${{ steps.version.outputs.new_version }}
  release-id:
    description: 'ID of the created release'
    value: ${{ steps.create-release.outputs.release_id }}
  release-url:
    description: 'URL of the created release'
    value: ${{ steps.create-release.outputs.release_url }}

runs:
  using: "composite"
  steps:
    # Calculate version using our script
    - name: Calculate new version
      id: version
      shell: bash
      run: |
        while IFS= read -r line; do
          if [[ "$line" == *"="* ]]; then
            echo "$line" >> $GITHUB_OUTPUT
          fi
        done < <(bash .github/scripts/version/calculate-version.sh \
          --package-path "${{ inputs.package-name }}" \
          --version-type "${{ inputs.version-type }}")
        
        # Log the new version to stderr
        echo "Calculated new version: ${{ steps.version.outputs.new_version }}" >&2

    # Create tag using our script
    - name: Create Git tag
      id: create-tag
      shell: bash
      run: |
        while IFS= read -r line; do
          if [[ "$line" == *"="* ]]; then
            echo "$line" >> $GITHUB_OUTPUT
          fi
        done < <(bash .github/scripts/version/create-tag.sh \
          --version "${{ steps.version.outputs.new_version }}" \
          --tag-prefix "v" \
          --message "Release v${{ steps.version.outputs.new_version }}")
        
        # Log the tag name to stderr
        echo "Created tag: ${{ steps.create-tag.outputs.tag_name }}" >&2

    # Create GitHub release using our script
    - name: Create GitHub release
      id: create-release
      shell: bash
      run: |
        while IFS= read -r line; do
          if [[ "$line" == *"="* ]]; then
            echo "$line" >> $GITHUB_OUTPUT
          fi
        done < <(bash .github/scripts/version/create-release.sh \
          --token "${{ inputs.github-token }}" \
          --repo "${{ inputs.repository }}" \
          --tag-name "${{ steps.create-tag.outputs.tag_name }}" \
          --name "Release ${{ steps.create-tag.outputs.tag_name }}" \
          --draft "${{ inputs.draft }}" \
          --prerelease "${{ inputs.prerelease }}" \
          --generate-notes "${{ inputs.generate-notes }}")
        
        # Log the release URL to stderr
        echo "Created release: ${{ steps.create-release.outputs.release_url }}" >&2

    # Publish to npm using our script
    - name: Publish to npm
      id: publish
      shell: bash
      run: |
        while IFS= read -r line; do
          if [[ "$line" == *"="* ]]; then
            echo "$line" >> $GITHUB_OUTPUT
          fi
        done < <(bash .github/scripts/version/publish-packages.sh \
          --package-path "${{ inputs.package-name }}" \
          --no-git-checks "true")
        
        # Log success message to stderr
        echo "Packages published successfully" >&2
      env:
        NODE_AUTH_TOKEN: ${{ inputs.github-token }} 