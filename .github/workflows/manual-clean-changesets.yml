name: Manual Clean and Generate Changesets

on:
  workflow_dispatch:

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  clean-and-generate:
    name: Clean and Generate Changesets
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      statuses: write
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.VERSION_TOKEN }}
      
      - name: Setup environment
        id: setup
        run: |
          # Run the setup script and filter only properly formatted output lines 
          bash .github/scripts/maintenance/setup-environment.sh \
            --github-token "${{ secrets.GITHUB_TOKEN }}" \
            --node-version "20.x" \
            --pnpm-version "8.15.4" \
            --registry-url "https://npm.pkg.github.com" \
            --scope "@littlecarlito" 2>&1 | grep -E "^[a-zA-Z0-9_-]+=.+" >> $GITHUB_OUTPUT || true

      # Create a unique branch for new changesets
      - name: Create branch for changesets
        id: create_branch
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BRANCH_NAME="chore/generate-changesets-$TIMESTAMP"
          echo "Creating branch: $BRANCH_NAME"
          git checkout -b $BRANCH_NAME
          git config --global user.name "Github Actions"
          git config --global user.email "actions@github.com"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      # Clear all unreleased changeset files
      - name: Clear unreleased changesets
        run: |
          echo "Cleaning all unreleased changeset files"
          rm -rf .changeset/*.md
          # Create README.md if it doesn't exist
          [ ! -f .changeset/README.md ] && echo "---\n# Changesets\n\nThis directory contains changeset files generated by the changeset tool." > .changeset/README.md
          
          # Commit the changes to clear changesets
          git add .changeset/
          git commit -m "chore: clear all unreleased changesets" || echo "No changes to commit"
      
      # Use our new action to generate precise changesets
      - name: Generate precise changesets
        id: generate_changesets
        uses: ./.github/actions/generate-precise-changesets
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          auto-changeset-prefix: 'auto-'
          force-generate: 'false'
      
      # Check if changesets were created
      - name: Check if changesets were created
        id: check_changesets
        run: |
          CHANGESET_COUNT=$(find .changeset -name "*.md" ! -name "README.md" ! -name "config.json" | wc -l)
          echo "changeset_count=$CHANGESET_COUNT" >> $GITHUB_OUTPUT
          
          # Check if there are actual changes to commit
          CHANGES=$(git status --porcelain .changeset/)
          
          echo "==== CHANGESET DEBUG INFO ===="
          echo "Changeset count: $CHANGESET_COUNT"
          if [ -n "$CHANGES" ]; then
            echo "Changes detected in .changeset directory:"
            echo "$CHANGES"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected in .changeset directory"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
          
          # List any changesets that exist
          if [ "$CHANGESET_COUNT" -gt "0" ]; then
            echo "Existing changesets:"
            find .changeset -name "*.md" ! -name "README.md" ! -name "config.json" | xargs cat
          fi
          echo "==== END CHANGESET DEBUG INFO ===="
      
      # Commit and push the generated changesets
      - name: Commit and push changesets
        id: commit_changesets
        if: steps.check_changesets.outputs.has_changes == 'true'
        run: |
          echo "Committing changes to .changeset directory"
          git add .changeset/
          git commit -m "chore: generate changesets for unreleased changes" || echo "No changes to commit"
          
          # Push the branch
          git push origin ${{ steps.create_branch.outputs.branch_name }}
          
          if [ $? -eq 0 ]; then
            echo "pushed_changes=true" >> $GITHUB_OUTPUT  
          else
            echo "pushed_changes=false" >> $GITHUB_OUTPUT
          fi
      
      # Create PR using the manage-pull-request action
      - name: Create PR
        id: create_pr
        if: steps.check_changesets.outputs.has_changes == 'true' && steps.commit_changesets.outputs.pushed_changes == 'true'
        uses: ./.github/actions/manage-pull-request
        with:
          github-token: ${{ secrets.PR_CREATION_TOKEN }}
          repository: ${{ github.repository }}
          base-branch: main
          head-branch: ${{ steps.create_branch.outputs.branch_name }}
          title: 'chore: generate changesets for unreleased changes'
          body: 'This PR generates changesets for unreleased changes since the last release or tag for each package, then cleans up existing changesets to start fresh.'
      
      # Add status checks to PR for workflow compatibility
      - name: Add status checks
        if: steps.check_changesets.outputs.has_changes == 'true' && steps.commit_changesets.outputs.pushed_changes == 'true' && steps.create_pr.outputs.pr-number != ''
        run: |
          bash .github/scripts/branch/force-status.sh \
            --token "${{ secrets.GITHUB_TOKEN }}" \
            --repo "${{ github.repository }}" \
            --sha "${{ steps.create_pr.outputs.commit-sha }}" \
            --contexts '["Build Packages", "Test / Run Tests", "Test Changesets"]' \
            --descriptions '["Build completed successfully (via manual-clean-changesets)", "Tests passed successfully (via manual-clean-changesets)", "Changesets validated successfully (via manual-clean-changesets)"]'
      
      # Wait for checks to complete before merging - INCREASED TIMEOUT
      - name: Wait for checks to complete
        if: steps.check_changesets.outputs.has_changes == 'true' && steps.commit_changesets.outputs.pushed_changes == 'true' && steps.create_pr.outputs.pr-number != ''
        run: |
          bash .github/scripts/branch/wait-with-delay.sh \
            --repo "${{ github.repository }}" \
            --sha "${{ steps.create_pr.outputs.commit-sha }}" \
            --workflow "Manual Clean and Generate Changesets" \
            --timeout "300" \
            --min-checks "3" \
            --initial-delay "30"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Merge the PR using the merge-pull-request action - ADD RETRY LOGIC
      - name: Merge pull request
        id: merge_pr
        if: steps.check_changesets.outputs.has_changes == 'true' && steps.commit_changesets.outputs.pushed_changes == 'true' && steps.create_pr.outputs.pr-number != ''
        run: |
          OUTPUT=$(bash .github/scripts/pr/merge-with-retry.sh \
            --pr-number "${{ steps.create_pr.outputs.pr-number }}" \
            --repository "${{ github.repository }}" \
            --attempts "3" \
            --delay "15" \
            --token "${{ secrets.VERSION_TOKEN }}")
          
          echo "$OUTPUT"
          # Extract and output merge_result for use in next steps
          MERGE_RESULT=$(echo "$OUTPUT" | grep "^merge_result=" | cut -d= -f2)
          echo "merge_result=$MERGE_RESULT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.VERSION_TOKEN }}
      
      # Output status message for completion
      - name: Status check
        id: status_check
        run: |
          if [ "${{ steps.check_changesets.outputs.has_changes }}" == "true" ] && [ "${{ steps.commit_changesets.outputs.pushed_changes }}" == "true" ] && [ -n "${{ steps.create_pr.outputs.pr-number }}" ]; then
            if [ "${{ steps.merge_pr.outputs.merge_result }}" == "success" ]; then
              echo "✅ Successfully generated changesets and merged PR #${{ steps.create_pr.outputs.pr-number }}"
              echo "Main pipeline will run and publish packages with direct publishing."
              echo "status=success" >> $GITHUB_OUTPUT
              echo "message=Successfully generated changesets and merged PR #${{ steps.create_pr.outputs.pr-number }}" >> $GITHUB_OUTPUT
            else
              echo "⚠️ Generated changesets and created PR #${{ steps.create_pr.outputs.pr-number }} but could not merge it"
              echo "Please check and merge the PR manually if needed."
              echo "status=partial" >> $GITHUB_OUTPUT
              echo "message=Generated changesets but failed to merge PR #${{ steps.create_pr.outputs.pr-number }}" >> $GITHUB_OUTPUT
              echo "step:Merge PR,error:Failed to merge PR #${{ steps.create_pr.outputs.pr-number }},skipped:None" >> $GITHUB_OUTPUT
            fi
          else
            if [ "${{ steps.check_changesets.outputs.has_changes }}" != "true" ]; then
              echo "ℹ️ No changes to commit: No new changesets were needed or could be created."
              echo "status=no_changes" >> $GITHUB_OUTPUT
              echo "message=No changes: No new changesets were needed or could be created" >> $GITHUB_OUTPUT
            elif [ "${{ steps.commit_changesets.outputs.pushed_changes }}" != "true" ]; then
              echo "❌ Failed to push changes: Changes were detected but could not be committed."
              echo "status=failure" >> $GITHUB_OUTPUT
              echo "message=Failed to commit changes" >> $GITHUB_OUTPUT
              echo "step:Commit Changes,error:Failed to push changes,skipped:Create PR, Add status checks, Wait for checks, Merge PR" >> $GITHUB_OUTPUT
            else
              echo "❌ Failed to create PR: Changes were committed but PR creation failed."
              echo "status=failure" >> $GITHUB_OUTPUT
              echo "message=Failed to create PR" >> $GITHUB_OUTPUT
              echo "step:Create PR,error:PR creation failed,skipped:Add status checks, Wait for checks, Merge PR" >> $GITHUB_OUTPUT
            fi
            echo "No action was needed or the process could not complete."
          fi
      
      # Check if report should be sent
      - name: Check if report should be sent
        if: failure() || steps.status_check.outputs.status == 'failure' || steps.status_check.outputs.status == 'partial'
        id: should_report
        run: |
          # Get the result based on status check
          if [[ "${{ steps.status_check.outputs.status }}" == "failure" ]]; then
            RESULT="failure"
          elif [[ "${{ steps.status_check.outputs.status }}" == "partial" ]]; then
            RESULT="partial"
          else
            RESULT="failure" # Default to failure if the job actually failed
          fi
          
          # Build summary with detailed information about what failed
          if [[ -n "${{ steps.status_check.outputs.step }}" ]]; then
            DETAILS="${{ steps.status_check.outputs.message }} (step: ${{ steps.status_check.outputs.step }})"
          else
            DETAILS="${{ steps.status_check.outputs.message || 'The manual clean changeset operation failed' }}"
          fi
          
          OUTPUT=$(bash .github/scripts/reporting/filter-workflow-reports.sh \
            --workflow-name "Manual Clean and Generate Changesets" \
            --branch "${{ github.ref_name }}" \
            --source "dispatch" \
            --summary "$DETAILS")
          
          echo "$OUTPUT"
          # Extract the should_report value
          SHOULD_REPORT=$(echo "$OUTPUT" | grep "^should_report=" | cut -d= -f2)
          echo "should_report=$SHOULD_REPORT" >> $GITHUB_OUTPUT
          echo "result=$RESULT" >> $GITHUB_OUTPUT
          echo "details=$DETAILS" >> $GITHUB_OUTPUT
          
      - name: Report result
        if: (failure() || steps.status_check.outputs.status == 'failure' || steps.status_check.outputs.status == 'partial') && steps.should_report.outputs.should_report == 'true'
        uses: ./.github/actions/report-workflow-results
        with:
          workflow-name: 'Manual Clean and Generate Changesets'
          result: ${{ steps.should_report.outputs.result }}
          branch: ${{ github.ref_name }}
          summary: '${{ steps.should_report.outputs.details }} (reported from ${{ github.ref_name }} branch)'
          source: 'dispatch'
          discord-webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          github-token: ${{ secrets.VERSION_TOKEN }} 