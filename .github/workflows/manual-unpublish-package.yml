name: Unpublish Package Version

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package name (e.g., blorktools or @littlecarlito/blorktools)'
        required: true
        type: string
      version:
        description: 'Version to unpublish (e.g., 1.13.0)'
        required: true
        type: string
      unpublish-tag:
        description: 'Also delete corresponding git tag'
        required: false
        type: boolean
        default: true
      dry-run:
        description: 'Dry run (show what would happen without doing it)'
        required: false
        type: boolean
        default: false

jobs:
  unpublish:
    name: Unpublish Package Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.VERSION_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@littlecarlito'
          
      - name: Unpublish package version
        id: unpublish
        env:
          GH_TOKEN: ${{ secrets.VERSION_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.VERSION_TOKEN }}
        run: |
          echo "Setting npm registry credentials..."
          echo "//npm.pkg.github.com/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
          echo "@littlecarlito:registry=https://npm.pkg.github.com" >> ~/.npmrc
          
          OUTPUT=$(bash .github/scripts/version/unpublish-package-versions.sh \
            --token "${GH_TOKEN}" \
            --package "${{ github.event.inputs.package }}" \
            --version "${{ github.event.inputs.version }}" \
            --repository "${{ github.repository }}" \
            --unpublish-tag "${{ github.event.inputs.unpublish-tag }}" \
            --dry-run "${{ github.event.inputs.dry-run }}")
            
          echo "$OUTPUT"
          # Extract the unpublished value
          UNPUBLISHED=$(echo "$OUTPUT" | grep "^unpublished=" | cut -d= -f2)
          PACKAGE=$(echo "$OUTPUT" | grep "^package=" | cut -d= -f2)
          VERSION=$(echo "$OUTPUT" | grep "^version=" | cut -d= -f2)
          
          if [[ "$UNPUBLISHED" == "true" ]]; then
            echo "Successfully unpublished $PACKAGE@$VERSION"
            echo "unpublished=true" >> $GITHUB_OUTPUT
          else
            echo "Dry run completed for $PACKAGE@$VERSION"
            echo "unpublished=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Report results
        if: always()
        run: |
          if [[ "${{ steps.unpublish.outputs.unpublished }}" == "true" ]]; then
            echo "âœ… Successfully unpublished ${{ github.event.inputs.package }}@${{ github.event.inputs.version }}"
            if [[ "${{ github.event.inputs.unpublish-tag }}" == "true" ]]; then
              echo "âœ… Also deleted corresponding Git tag(s)"
            fi
          elif [[ "${{ github.event.inputs.dry-run }}" == "true" ]]; then
            echo "ğŸ” Dry run completed for ${{ github.event.inputs.package }}@${{ github.event.inputs.version }}"
            echo "No actual changes were made."
          else 
            echo "âŒ Failed to unpublish ${{ github.event.inputs.package }}@${{ github.event.inputs.version }}"
            echo "Check the logs for more details."
          fi
      
      # Report failure using the new action    
      - name: Report failure
        if: failure()
        uses: ./.github/actions/report-workflow-results
        with:
          workflow-name: 'Manual Unpublish Package'
          result: 'failure'
          branch: ${{ github.ref_name }}
          summary: 'Failed to unpublish ${{ github.event.inputs.package }}@${{ github.event.inputs.version }}'
          source: 'dispatch'
          discord-webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          github-token: ${{ secrets.VERSION_TOKEN }} 