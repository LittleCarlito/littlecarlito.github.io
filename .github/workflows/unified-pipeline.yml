name: Unified Pipeline

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write
  actions: read

jobs:
  build:
    name: Build Packages
    uses: ./.github/workflows/jobs/build-job.yml

  test:
    name: Test Packages
    needs: build
    uses: ./.github/workflows/jobs/test-job.yml

  analyze-and-release:
    name: Analyze Commits and Release
    needs: test
    uses: ./.github/workflows/jobs/semantic-release-job.yml
    with:
      dry_run: false
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  publish-blorkpack:
    name: Publish blorkpack Package
    needs: analyze-and-release
    uses: ./.github/workflows/jobs/publish-package-job.yml
    with:
      package_name: blorkpack
      package_version: ${{ needs.analyze-and-release.outputs.blorkpack_version }}
      should_publish: ${{ needs.analyze-and-release.outputs.blorkpack_version_changed == 'true' }}
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  publish-blorktools:
    name: Publish blorktools Package
    needs: analyze-and-release
    uses: ./.github/workflows/jobs/publish-package-job.yml
    with:
      package_name: blorktools
      package_version: ${{ needs.analyze-and-release.outputs.blorktools_version }}
      should_publish: ${{ needs.analyze-and-release.outputs.blorktools_version_changed == 'true' }}
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }}

  deploy:
    name: Deploy to GitHub Pages
    needs: [analyze-and-release, publish-blorkpack, publish-blorktools, build, test]
    uses: ./.github/workflows/jobs/deploy-job.yml
    with:
      package_version: ${{ needs.analyze-and-release.outputs.blorkpack_version }}
    secrets:
      PACKAGE_TOKEN: ${{ secrets.PACKAGE_TOKEN }} 